<div class="sheet-sd">
	<div class="sheet-section-roll-advantage">
		<div class="sd-row">
			<label title="How shall thy fate be decided?">Roll</label>
			<label class="sheet-radio">
				<input type="radio" name="attr_advantagetoggle" value="{{query=1}} {{advantage=1}} {{r2=[[@{d20}">
				<span title="@{advantagetoggle}">Adv</span>
			</label>
			<label class="sheet-radio">
				<input type="radio" name="attr_advantagetoggle" value="{{query=1}} {{normal=1}} {{r2=[[0d20" checked="checked">
				<span title="@{advantagetoggle}">Normal</span>
			</label>
			<label class="sheet-radio">
				<input type="radio" name="attr_advantagetoggle" value="{{query=1}} {{disadvantage=1}} {{r2=[[@{d20}">
				<span title="@{advantagetoggle}">Disadv</span>
			</label>
		</div>
	</div>
	<div class="sheet-section-roll-whisper">
		<div class="sd-row">
			<label title="To whom shall thy fate be revealed?">Show</label>
			<label class="sheet-radio">
				<input type="radio" name="attr_whispertoggle" value="" checked="checked">
				<span title="@{whispertoggle}">Public</span>
			</label>
			<label class="sheet-radio">
				<input type="radio" name="attr_whispertoggle" value="/w gm ">
				<span title="@{whispertoggle}">To GM</span>
			</label>
		</div>
	</div>
	<input class="sheet-toggle-npc" name="attr_npc" type="hidden" value="0">
	<div class="sheet-type-npc sheet-section-npc-identity">
		<h1>NPC</h1>
		<div class="sd-row">
			<div class="sd-col">
				<label for="npc_name">Name</label>
				<input type="text" class="sd-text" name="attr_character_name" title="@{character_name}" id="npc_name"
					placeholder="Name">
			</div>
			<div class="sd-col">
				<label for="npc_level">Level</label>
				<input type="text" class="sd-num" name="attr_base_level" title="@{base_level}" id="npc_level" value="1" placeholder="level">
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<label for="npc_movement">Movement</label>
				<input type="text" class="sd-text" name="attr_movement" title="@{attr_movement}" id="npc_movement"
					value="Near" placeholder="near, double near, etc.">
			</div>
			<div class="sd-col">
				<label for="npc_alignment">Alignment</label>
				<input type="text" class="sd-text" name="attr_alignment" title="@{alignment}" id="npc_alignment"
					value="Chaotic" placeholder="Chaotic, Lawful, Neutral">
			</div>
		</div>
		<input class="sheet-toggle-npc-desc" name="attr_npc_showdesc" type="hidden" value="0">
		<div class="sheet-section-npc-desc">
			<div class="sd-row">
				<div class="sd-col">
					<label for="npc_description">Description</label>
					<textarea class="sd-text" name="attr_description" title="@{description}" id="npc_description"></textarea>
				</div>
			</div>
		</div>
	</div>
	<div class="sheet-type-pc sheet-section-pc-identity">
		<h1>Crawler</h1>
		<div class="sd-row">
			<div class="sd-col">
				<label for="pc_name">Name</label>
				<input type="text" class="sd-text" name="attr_character_name" title="@{character_name}" id="pc_name"
					placeholder="Name">
			</div>
			<div class="sd-col">
				<label for="pc_ancestry">Ancestry</label>
				<input type="text" class="sd-text" name="attr_ancestry" title="@{attr_ancestry}" id="pc_ancestry"
					placeholder="Ancestry">
			</div>
			<div class="sd-col">
				<label for="pc_background">Background</label>
				<input type="text" class="sd-text" name="attr_background" title="@{background}" id="pc_background"
					placeholder="Background">
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<label for="pc_class">Class</label>
				<input type="text" class="sd-text" name="attr_class" title="@{class}" id="pc_class" placeholder="Class">
			</div>
			<div class="sd-col">
				<label for="pc_level">Level</span></label>
				<input type="text" class="sd-num" name="attr_base_level" title="@{base_level}" id="pc_level" value="0" min="0"
					max="10">
			</div>
			<div class="sd-col">
				<div>
					<label for="pc_xp_current">XP (<span name="attr_lifetime_xp" title="@{lifetime_xp}">0</span> total)</label>
					<input type="text" class="sd-num" name="attr_xp" title="@{xp}" value="0" id="pc_xp_current" min="0"
						max="450">
					<span>/</span>
					<span class="sd-num" name="attr_xp_nextlevel" title="@{xp_nextlevel}">
				</div>
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<label for="pc_title">Title</label>
				<input type="text" class="sd-text" name="attr_title" title="@{title}" id="pc_title" placeholder="Title">
			</div>
			<div class="sd-col">
				<label for="pc_alignment">Alignment</label>
				<input type="text" class="sd-text" name="attr_alignment" title="@{alignment}" id="pc_alignment"
					placeholder="Alignment">
			</div>
			<div class="sd-col">
				<label for="pc_deity">Deity</label>
				<input type="text" class="sd-text" name="attr_deity" title="@{deity}" id="pc_deity" placeholder="Deity">
			</div>
		</div>
	</div>
	<div class="sheet-type-npc sheet-section-npc-stats">
		<h1>NPC Stats</h1>
		<div class="sd-row">
			<div class="sd-col">
				<div>
					<label for="npc_hp_max" title="Hit Points">HP</label>
					<input type="text" class="sd-num" name="attr_hp_max" title="@{hp_max}" id="npc_hp_max" value="1" placeholder="HP">
				</div>
			</div>
			<div class="sd-col">
				<label for="npc_ac" title="Armor Class">AC</label>
				<input type="text" class="sd-num" name="attr_ac" title="@{ac}" value="10" id="npc_ac" placeholder="AC">
			</div>
			<div class="sd-col">
				<label for="npc_armor" title="Armor Type">Armor</label>
				<input type="text" class="sd-text" name="attr_armor" title="@{armor}" value="Natural armor" placeholder="Armor type" id="npc_armor">
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_strength" title="Strength check"
						value="@{wtype}&{template:simple} {{rname=Strength}} {{mod=@{strength_mod}}} {{r1=[[@{d20}+@{strength_mod}]]}} @{rtype}+@{strength_mod}]]}} @{charname_output}">STR</button>
					<input type="text" class="sd-num" name="attr_strength_mod" title="@{strength_mod}" value="0">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_dexterity" title="Dexterity check"
						value="@{wtype}&{template:simple} {{rname=Dexterity}} {{mod=@{dexterity_mod}}} {{r1=[[@{d20}+@{dexterity_mod}]]}} @{rtype}+@{dexterity_mod}]]}} @{charname_output}">DEX</button>
					<input type="text" class="sd-num" name="attr_dexterity_mod" title="@{dexterity_mod}" value="0">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_constitution" title="Constitution check"
						value="@{wtype}&{template:simple} {{rname=Constitution}} {{mod=@{constitution_mod}}} {{r1=[[@{d20}+@{constitution_mod}]]}} @{rtype}+@{constitution_mod}]]}} @{charname_output}">CON</button>
					<input type="text" class="sd-num" name="attr_constitution_mod" title="@{constitution_mod}" value="0">
				</div>
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_wisdom" title="Wisdom check"
						value="@{wtype}&{template:simple} {{rname=Wisdom}} {{mod=@{wisdom_mod}}} {{r1=[[@{d20}+@{wisdom_mod}]]}} @{rtype}+@{wisdom_mod}]]}} @{charname_output}">WIS</button>
					<input type="text" class="sd-num" name="attr_wisdom_mod" title="@{wisdom_mod}" value="10">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_intelligence" title="Intelligence check"
						value="@{wtype}&{template:simple} {{rname=Intelligence}} {{mod=@{intelligence_mod}}} {{r1=[[@{d20}+@{intelligence_mod}]]}} @{rtype}+@{intelligence_mod}]]}} @{charname_output}">INT</button>
					<input type="text" class="sd-num" name="attr_intelligence_mod" title="@{intelligence_mod}" value="0">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_charisma" title="Charisma check"
						value="@{wtype}&{template:simple} {{rname=Charisma}} {{mod=@{charisma_mod}}} {{r1=[[@{d20}+@{charisma_mod}]]}} @{rtype}+@{charisma_mod}]]}} @{charname_output}">CHA</button>
					<input type="text" class="sd-num" name="attr_charisma_mod" title="@{charisma_mod}" value="0">
				</div>
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col pc-initiative">
				<button type="roll" name="roll_initiative" title="Roll initiative for PC; click token first"
					value="@{wtype}&{template:simple} {{rname=Initiative}} {{r1=[[@{d20}+@{dexterity_mod}[INIT] &{tracker}]]}} {{normal=1}} @{charname_output}">Initiative</button>
			</div>
		</div>
	</div>	
	<div class="sheet-type-pc sheet-section-pc-stats">
		<h1>
			<span class="section-title">Stats</span>
			<div class="luck-tokens">
				<span>Luck</span>
				<input type="checkbox" name="attr_lucktoken1" title="@{lucktoken1}">
				<input type="checkbox" name="attr_lucktoken2" title="@{lucktoken2}">
				<input type="checkbox" name="attr_lucktoken3" title="@{lucktoken3}">
				<input type="checkbox" name="attr_lucktoken4" title="@{lucktoken4}">
				<input type="checkbox" name="attr_lucktoken5" title="@{lucktoken5}">
				<input type="checkbox" name="attr_lucktoken6" title="@{lucktoken6}">
			</div>
		</h1>
		<div class="sd-row">
			<div class="sd-col">
				<div>
					<label for="pc_hp_current" title="Hit Points">HP</label>
					<input type="text" class="sd-num" name="attr_hp" title="@{hp}" id="pc_hp_current" placeholder="HP">
					<span>/</span>
					<input type="text" class="sd-num" name="attr_hp_max" title="@{hp_max} id=" pc_hp_max" placeholder="Max">
				</div>
			</div>
			<div class="sd-col">
				<label for="pc_ac" title="Armor Class">AC</label>
				<input type="text" class="sd-num" name="attr_ac" title="@{ac}" value="10" id="pc_ac" placeholder="AC">
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_strength" title="Strength check"
						value="@{wtype}&{template:simple} {{rname=Strength}} {{mod=@{strength_mod}}} {{r1=[[@{d20}+@{strength_mod}]]}} @{rtype}+@{strength_mod}]]}} @{charname_output}">STR</button>
					<input type="text" class="sd-num" name="attr_strength_base" title="@{strength}" value="10" min="1"
						max="99">
					<span>/</span>
					<span class="sd-num" name="attr_strength_mod" title="@{strength_mod}">0</span>
					<input type="hidden" name="attr_strength" value="10">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_intelligence" title="Intelligence check"
						value="@{wtype}&{template:simple} {{rname=Intelligence}} {{mod=@{intelligence_mod}}} {{r1=[[@{d20}+@{intelligence_mod}]]}} @{rtype}+@{intelligence_mod}]]}} @{charname_output}">INT</button>
					<input type="text" class="sd-num" name="attr_intelligence_base" title="@{intelligence}" value="10" min="1"
						max="99">
					<span>/</span>
					<span class="sd-num" name="attr_intelligence_mod" title="@{intelligence_mod}">0</span>
					<input type="hidden" name="attr_intelligence" value="10">
				</div>
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_dexterity" title="Dexterity check"
						value="@{wtype}&{template:simple} {{rname=Dexterity}} {{mod=@{dexterity_mod}}} {{r1=[[@{d20}+@{dexterity_mod}]]}} @{rtype}+@{dexterity_mod}]]}} @{charname_output}">DEX</button>
					<input type="text" class="sd-num" name="attr_dexterity_base" title="@{dexterity}" value="10" min="1"
						max="99">
					<span>/</span>
					<span class="sd-num" name="attr_dexterity_mod" title="@{dexterity_mod}">0</span>
					<input type="hidden" name="attr_dexterity" value="10">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_wisdom" title="Wisdom check"
						value="@{wtype}&{template:simple} {{rname=Wisdom}} {{mod=@{wisdom_mod}}} {{r1=[[@{d20}+@{wisdom_mod}]]}} @{rtype}+@{wisdom_mod}]]}} @{charname_output}">WIS</button>
					<input type="text" class="sd-num" name="attr_wisdom_base" title="@{wisdom}" value="10" min="1" max="99">
					<span>/</span>
					<span class="sd-num" name="attr_wisdom_mod" title="@{wisdom_mod}">0</span>
					<input type="hidden" name="attr_wisdom" value="10">
				</div>
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_constitution" title="Constitution check"
						value="@{wtype}&{template:simple} {{rname=Constitution}} {{mod=@{constitution_mod}}} {{r1=[[@{d20}+@{constitution_mod}]]}} @{rtype}+@{constitution_mod}]]}} @{charname_output}">CON</button>
					<input type="text" class="sd-num" name="attr_constitution_base" title="@{constitution}" value="10" min="1"
						max="99">
					<span>/</span>
					<span class="sd-num" name="attr_constitution_mod" title="@{constitution_mod}">0</span>
					<input type="hidden" name="attr_constitution" value="10">
				</div>
			</div>
			<div class="sd-col">
				<div class="sd-core-stat">
					<button type="roll" name="roll_charisma" title="Charisma check"
						value="@{wtype}&{template:simple} {{rname=Charisma}} {{mod=@{charisma_mod}}} {{r1=[[@{d20}+@{charisma_mod}]]}} @{rtype}+@{charisma_mod}]]}} @{charname_output}">CHA</button>
					<input type="text" class="sd-num" name="attr_charisma_base" title="@{charisma}" value="10" min="1"
						max="99">
					<span>/</span>
					<span class="sd-num" name="attr_charisma_mod" title="@{charisma_mod}">0</span>
					<input type="hidden" name="attr_charisma" value="10">
				</div>
			</div>
		</div>
		<div class="sd-row">
			<div class="sd-col pc-initiative">
				<button type="roll" name="roll_initiative" title="Roll initiative for PC; click token first"
					value="@{wtype}&{template:simple} {{rname=Initiative}} {{r1=[[@{d20}+@{dexterity_mod}[INIT] &{tracker}]]}} {{normal=1}} @{charname_output}">Initiative</button>
			</div>
		</div>
	</div>
	<div class="sheet-section-actions">
		<h1>Attacks &amp; Spells</h1>
		<div>
			<fieldset class="repeating_attack">
				<div class="sheet-fieldset-item">
					<div class="sheet-checkbox-cog">
						<input type="checkbox" name="attr_options-flag" checked="checked"><span></span>
						<span class="sheet-toggle-icon"></span>
					</div>
					<input type="checkbox" name="attr_options-flag" checked="checked" class="sheet-toggle" hidden>
					<div class="sheet-toggle-checked">
						<div class="sheet-form">
							<div class="sheet-form-body">
								<div class="sheet-form-group">
									<label>Edit Name:</label>
									<input type="text" name="attr_atkname" placeholder="Weapon or Spell">
								</div>
								<div class="sheet-form-group">
									<label class="sheet-form-checkbox">
										<input type="checkbox" name="attr_atkflag" value="{{attack=1}}" checked="checked">
										<span>Roll Stat + Bonus:</span>
									</label>
								</div>
								<div class="sheet-form-group">
									<select name="attr_atkattr_base">
										<option value="@{strength_mod}" selected="selected">STR</option>
										<option value="@{dexterity_mod}">DEX</option>
										<option value="@{intelligence_mod}">INT</option>
										<option value="@{wisdom_mod}">WIS</option>
										<option value="0">-</option>
									</select>
									<span>+</span>
									<input type="text" name="attr_atkmod">
								</div>
								<div class="sheet-form-group">
									<div class="sd-row">
										<div class="sd-col">
											<label>Spell Duration:</label>
											<input type="text" name="attr_duration" placeholder="instant, 1 turn, 1 minute, etc.">
										</div>
										<div class="sd-col">
											<label>DC to Cast:</label>
											<input type="text" class="sd-num" name="attr_castdc" value="11">
										</div>
									</div>
								</div>
								<div class="sheet-form-group">
									<label>Attack/Spell Range:</label>
									<input type="text" name="attr_atkrange" placeholder="close, far, near, etc.">
								</div>
								<div class="sheet-form-group">
									<label>Other Bonus:</label>
									<input type="text" name="attr_atkmagic">
									<label>Minimum Die Roll To Crit:</label>
									<input type="text" name="attr_atkcritrange" value="20">
								</div>
								<div class="sheet-form-group">
									<label class="sheet-form-checkbox">
										<input type="checkbox" name="attr_dmgflag" value="{{damage=1}} {{dmg1flag=1}}"
											checked="checked">
										<span>Damage Type 1</span>
									</label>
								</div>
								<div class="sheet-form-group">
									<label>Damage Roll + Bonus:</label>
									<input type="text" name="attr_dmgbase">
									<span>+</span>
									<input type="text" name="attr_dmgmod">
								</div>
								<div class="sheet-form-group">
									<label>Crit Roll or Damage (if not roll twice):</label>
									<input type="text" name="attr_dmgcustcrit">
								</div>
								<div class="sheet-form-group">
									<label class="sheet-form-checkbox">
										<input type="checkbox" name="attr_dmg2flag" value="{{damage=1}} {{dmg2flag=1}}">
										<span>Damage Type 2</span>
									</label>
								</div>
								<div class="sheet-form-group">
									<label>Damage Roll + Bonus:</label>
									<input type="text" name="attr_dmg2base">
									<span>+</span>
									<input type="text" name="attr_dmg2mod">
								</div>
								<div class="sheet-form-group">
									<label>Crit Roll or Damage (if not roll twice):</label>
									<input type="text" name="attr_dmg2custcrit">
								</div>
								<div class="sheet-form-group sheet-form-group-column">
									<label>Description or Flavor Text:</label>
									<textarea name="attr_atk_desc"></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="sheet-toggle-unchecked">
						<div class="sheet-pc-attack">
							<input type="text" name="attr_atkbonus" class="sheet-hidden" value="">
							<input type="text" name="attr_atkdmgtype" class="sheet-hidden" value="">
							<input type="checkbox" class="atk-equipped" name="attr_equipped" title="Equipped / Usable">
							<button type="roll" name="roll_attack" value="@{rollbase}" class="sheet-attack-button">
								<span name="attr_atkname"></span>
								(<span name="attr_atkbonus"></span>)
								<span name="attr_atkdmgtype"></span>
							</button>
						</div>
					</div>
				</div>
				<input type="hidden" name="attr_rollbase">
				<input type="hidden" name="attr_rollbase_dmg">
				<input type="hidden" name="attr_rollbase_crit">
				<input type="hidden" name="attr_hldmg">
				<input type="hidden" name="attr_spelllevel">
				<input type="hidden" name="attr_itemid">
				<input type="hidden" name="attr_spellid">
				<input type="hidden" name="attr_spell_innate">
				<input type="hidden" name="attr_versatile_alt">
				<button type="roll" name="roll_attack_dmg" value="@{rollbase_dmg}" class="sheet-hidden"></button>
				<button type="roll" name="roll_attack_crit" value="@{rollbase_crit}" class="sheet-hidden"></button>
			</fieldset>
		</div>
	</div>
	<div class="sheet-section-features">
		<h1>Talents, Traits, Abilities, Notes</h1>
		<div class="sheet-container-body">
			<fieldset class="repeating_traits">
				<div class="sheet-fieldset-item">
					<div class="sheet-checkbox-cog">
						<input type="checkbox" name="attr_options-flag" checked="checked">
						<span class="sheet-toggle-icon"></span>
					</div>
					<input type="checkbox" name="attr_options-flag" checked="checked" class="sheet-toggle" hidden>
					<div class="sheet-toggle-checked">
						<div class="sheet-form">
							<div class="sheet-form-body">
								<div class="sheet-form-group">
									<label>
										Edit Trait<br>
										<input type="text" name="attr_name" class="trait-name" maxlength="60">
									</label>
								</div>
								<div class="sheet-form-group">
									<label>
										Edit Details<br>
										<textarea name="attr_description" class="trait-desc"></textarea>
									</label>
								</div>
								<div class="sheet-form-group">
									<label class="sheet-form-checkbox">
										<input type="checkbox" name="attr_hide_details" value="1">
										<span>Hide Details in List View</span>
									</label>
								</div>
							</div>
						</div>
					</div>
					<div class="sheet-toggle-unchecked">
						<div class="sheet-feature">
							<button type="roll" name="roll_output"
								value="@{wtype}&{template:traits} @{charname_output} {{name=@{name}}} {{description=@{description}}}">
								<div class="sheet-feature-name">
									<span name="attr_name"></span>
								</div>
								<input type="hidden" name="attr_hide_details" class="sheet-field-untoggle">
								<div class="sheet-feature-details">
									<span name="attr_description"></span>
								</div>
							</button>
						</div>
					</div>
				</div>
			</fieldset>
		</div>
	</div>
	<div class="sheet-type-pc sheet-section-pc-gear">
		<h1>Gear</h1>
		<div class="sd-row">
			<div class="sd-col sd-coinage">
				<label><span>GP</span><input type="text" class="sd-num" name="attr_gp" title="@{gp}" value="0"></label>
			</div>
			<div class="sd-col sd-coinage">
				<label><span>SP</span><input type="text" class="sd-num" name="attr_sp" title="@{sp}" value="0"></label>
			</div>
			<div class="sd-col sd-coinage">
				<label><span>CP</span><input type="text" class="sd-num" name="attr_cp" title="@{cp}" value="0"></label>
			</div>
			<div class="sd-col">
				<input type="hidden" class="sd-num" name="attr_slots" title="@{slots}" id="pc_slots_current" value="0">
				<label>
					<span>Slots</span>
					<input type="text" class="sd-num" name="attr_slots_max" title="@{slots_max}" id="pc_slots_max" value="10">
				</label>
			</div>
		</div>
		<div class="sd-gear-slots">
			<div class="sd-row">
				<div class="sd-col">
					<label><span>1.</span><input type="hidden" name="attr_gearslot1enabled" value="1"><input type="text"
							class="sd-text gearslot1" name="attr_gearslot1" title="@{gearslot1}"></label>
					<label><span>2.</span><input type="hidden" name="attr_gearslot2enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot2" title="@{gearslot2}"></label>
					<label><span>3.</span><input type="hidden" name="attr_gearslot3enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot3" title="@{gearslot3}"></label>
					<label><span>4.</span><input type="hidden" name="attr_gearslot4enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot4" title="@{gearslot4}"></label>
					<label><span>5.</span><input type="hidden" name="attr_gearslot5enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot5" title="@{gearslot5}"></label>
					<label><span>6.</span><input type="hidden" name="attr_gearslot6enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot6" title="@{gearslot6}"></label>
					<label><span>7.</span><input type="hidden" name="attr_gearslot7enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot7" title="@{gearslot7}"></label>
					<label><span>8.</span><input type="hidden" name="attr_gearslot8enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot8" title="@{gearslot8}"></label>
					<label><span>9.</span><input type="hidden" name="attr_gearslot9enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot9" title="@{gearslot9}"></label>
					<label><span>10.</span><input type="hidden" name="attr_gearslot10enabled" value="1"><input type="text"
							class="sd-text" name="attr_gearslot10" title="@{gearslot10}"></label>
					<label><span>11.</span><input type="hidden" name="attr_gearslot11enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot11" title="@{gearslot11}"></label>
				</div>
				<div class="sd-col">
					<label><span>12.</span><input type="hidden" name="attr_gearslot12enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot12" title="@{gearslot12}"></label>
					<label><span>13.</span><input type="hidden" name="attr_gearslot13enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot13" title="@{gearslot13}"></label>
					<label><span>14.</span><input type="hidden" name="attr_gearslot14enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot14" title="@{gearslot14}"></label>
					<label><span>15.</span><input type="hidden" name="attr_gearslot15enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot15" title="@{gearslot15}"></label>
					<label><span>16.</span><input type="hidden" name="attr_gearslot16enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot16" title="@{gearslot16}"></label>
					<label><span>17.</span><input type="hidden" name="attr_gearslot17enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot17" title="@{gearslot17}"></label>
					<label><span>18.</span><input type="hidden" name="attr_gearslot18enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot18" title="@{gearslot18}"></label>
					<label><span>19.</span><input type="hidden" name="attr_gearslot19enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot19" title="@{gearslot19}"></label>
					<label><span>20.</span><input type="hidden" name="attr_gearslot20enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot20" title="@{gearslot20}"></label>
					<label><span>21.</span><input type="hidden" name="attr_gearslot21enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot21" title="@{gearslot21}"></label>
					<label><span>22.</span><input type="hidden" name="attr_gearslot22enabled" value="0"><input type="text"
							class="sd-text" name="attr_gearslot22" title="@{gearslot22}"></label>
				</div>
			</div>
		</div>
		<div class="sd-gear-noslots">
			<div class="sd-row">
				<div class="sd-col">
					<label>
						<div>
							<span>Other Gear, Personal Treasure, etc.</span>
						</div>
						<div>
							<textarea class="sd-text" name="attr_gearnoslots" title="@{gearnoslots}"></textarea>
						</div>
					</label>
				</div>
			</div>
		</div>
	</div>
	<div class="sheet-toggler-options">
		<label class="sheet-form-checkbox" title="@{show_options}">
			<input type="checkbox" name="attr_show_options" value="1">
			<span>Show Sheet Options</span>
		</label>
	</div>
	<input class="sheet-toggle-options" name="attr_show_options" type="hidden" value="0">
	<div class="sheet-section-options">
		<h1>Sheet Options</h1>
		<div class="sheet-form-body">
			<div class="sheet-form-group">
				<label class="sheet-form-checkbox" title="@{npc}">
					<input type="checkbox" name="attr_npc" value="1">
					<span>NPC Sheet</span>
				</label>
			</div>
			<div class="sheet-form-group">
				<label class="sheet-form-checkbox" title="@{npc_showdesc}">
					<input type="checkbox" name="attr_npc_showdesc" value="1">
					<span>Show NPC Description</span>
				</label>
			</div>
			<div class="sheet-form-group">
				<div>
					<button type="action" name="act_randomlevelzero">Generate Random Level 0 PC</button>
					<button type="action" name="act_importjson">Import Shadowdarklings JSON</button>
					<button type="action" name="act_importmonster">Import Monster Text from Book</button>
				</div>
				<label class="sheet-form-checkbox" title="@{levelzero_confirm_flag}">
					<input type="checkbox" name="attr_levelzero_confirm_flag" value="1">
					<span>"By checking this box, I officially swear that I want to reset my PC"</span>
				</label>
			</div>
			<div class="sheet-form-group">
				<label>JSON or Monster Text</label>
				<textarea name="attr_json" title="@{json}"></textarea>
			</div>
			<div class="sheet-form-group">
				<label>Version:</label>
				<input type="text" name="attr_version" value="2024.1.17.1" hidden disabled>
				<span name="attr_version"></span>
			</div>
			<div>
				<span>Roll20 Character Sheet for Shadowdark RPG</span>
				<div class="legal">
					<div>LEGAL:</div>
					<div>
						Roll20 Character Sheet for Shadowdark RPG is an independent product published under the Shadowdark RPG
						Third-Party License and is not affiliated with The Arcane Library, LLC. Shadowdark RPG © 2023 The Arcane
						Library, LLC.
					</div>
					<div>
						Have fun, and use at your own risk!
					</div>
					<div>CREDIT AND THANKS:</div>
					<div>
						<ul class="sd-credits">
							<li>Giffyglyph for creating the 5e Darker Dungeons sheet because I simply copied and hacked the hells
								out of it.</li>
							<li>Kelsey for creating Shadowdark RPG, and the entire Shadowdark RPG community for supporting the
								game, and Herpopotamus for motivation and letting me bouncing ideas around, and all the folks who
								kindly shared their time for feedback and testing</li>
							<li>Roll20 for letting for keeping my friends and me (roll20: CyberSasquatch; discord: thescratch) sane during the pandemic</li>
							<li>Last but not least: THANK YOU for using this (and for your patience while bugs are worked out)
							</li>
						</ul>
					</div>
					</p>
				</div>
			</div>
		</div>
	</div>
	<div class="sheet-section-fields">
		<input type="hidden" name="attr_charname_output" value="{{charname=@{character_name}}}">
		<input type="hidden" name="attr_d20" value="1d20">
		<input type="hidden" name="attr_xp_nextlevel" value="10">
		<input type="hidden" name="attr_level" value="1">
		<input type="hidden" name="attr_initiative_bonus" value="0">
		<input type="hidden" name="attr_strength_mod" value="0">
		<input type="hidden" name="attr_dexterity_mod" value="0">
		<input type="hidden" name="attr_constitution_mod" value="0">
		<input type="hidden" name="attr_intelligence_mod" value="0">
		<input type="hidden" name="attr_wisdom_mod" value="0">
		<input type="hidden" name="attr_charisma_mod" value="0">
		<input type="hidden" name="attr_wtype" value="@{whispertoggle}">
		<input type="hidden" name="attr_rtype" value="@{advantagetoggle}">
		<input type="hidden" name="attr_global_attack_mod" value="">
		<input type="hidden" name="attr_global_attack_mod_flag" value="">
		<input type="hidden" name="attr_global_damage_mod" value="">
		<input type="hidden" name="attr_global_damage_mod_flag" value="">
		<input type="hidden" name="attr_global_damage_mod_type" value="">
		<input type="hidden" name="attr_global_ac_mod" value="">
		<input type="hidden" name="attr_global_ac_mod_flag" value="">
	</div>
	<div class="sheet-section-templates">
		<div class="sheet-rolltemplates">
			<rolltemplate class="sheet-rolltemplate-atk">
				<div class="sheet-container">
					<div class="char-name">
						<span>{{charname}}</span>
					</div>
					<div class="result">
						{{#normal}}
						<div class="solo">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRITICAL SUCCESS!</div>{{/rollWasCrit() r1}}
						{{#rollWasFumble() r1}}<div class="crit-fail">CRITICAL FAILURE!</div>{{/rollWasFumble() r1}}
						{{/normal}}
						{{#advantage}}
						{{#rollLess() r1 r2}}
						<div class="adv">
							<span class="roll-unused">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasCrit() r2}}<div class="crit-success">CRITICAL SUCCESS!</div>{{/rollWasCrit() r2}}
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRITICAL SUCCESS!</div>{{/rollWasCrit() r1}}
						{{#rollWasFumble() r1}}<div class="crit-fail">CRITICAL FAIL!</div>{{/rollWasFumble() r1}}
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-unused">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRITICAL SUCCESS!</div>{{/rollWasCrit() r1}}
						{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollLess() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-unused">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasFumble() r1}}<div class="crit-fail">CRITICAL FAIL!</div>{{/rollWasFumble() r1}}
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRITICAL SUCCESS!</div>{{/rollWasCrit() r1}}
						{{#rollWasFumble() r1}}<div class="crit-fail">CRITICAL FAIL!</div>{{/rollWasFumble() r1}}
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<div class="adv">
							<span class="roll-unused">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{#rollWasFumble() r2}}<div class="crit-fail">CRITICAL FAIL!</div>{{/rollWasFumble() r2}}
						{{/rollGreater() r1 r2}}
						{{/disadvantage}}
					</div>
					{{#atkrange}}
					<div class="sublabel">
						<span>{{atkrange}}</span>
					</div>
					{{/atkrange}}
					<div class="label">
						{{#normal}}
						{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span>, {{innate}}</span>{{/innate}}
							<span>({{mod}})</span></span>{{/rollWasCrit() r1}}
						{{#^rollWasCrit() r1}}<span>{{rname}}{{#innate}}<span>, {{innate}}</span>{{/innate}}
							<span>({{mod}})</span></span>{{/^rollWasCrit() r1}}
						{{/normal}}
						{{#always}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
						{{/always}}
						{{#advantage}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}<span>{{rname}}{{#innate}}<span>,
								{{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollLess() r1 r2}}<span>{{rname}}{{#innate}}<span>, {{innate}}</span>{{/innate}}
							<span>({{mod}})</span></span>{{/rollLess() r1 r2}}
						{{#rollGreater() r1 r2}}<span>{{rname}}{{#innate}}<span>, {{innate}}</span>{{/innate}}
							<span>({{mod}})</span></span>{{/rollGreater() r1 r2}}
						{{/disadvantage}}
					</div>
					{{#duration}}
					<div class="info">
						<span>Duration: {{duration}}</span>; <span>Cast DC: {{castdc}}</span>
					</div>
					{{/duration}}
					{{#range}}
					<div class="info">
						<span>Range: {{range}}</span>
					</div>
					{{/range}}
					{{#desc}}
					<div class="desc info">
						<span>
							<span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
						</span>
					</div>
					{{/desc}}
				</div>
			</rolltemplate>

			<rolltemplate class="sheet-rolltemplate-atkdmg">
				{{#attack}}
				<div class="container atk">
					<div class="charname">
						<span>{{charname}}: {{rname}}</span>
					</div>
					<div class="result">
						{{#always}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/always}}
						{{#normal}}
						<div class="solo">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/normal}}
						{{#advantage}}
						{{#rollLess() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollLess() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
						</div>
						{{/rollGreater() r1 r2}}
						{{/disadvantage}}
					</div>
					{{#range}}
					<div class="sublabel">
						<span>{{range}}</span>
					</div>
					{{/range}}
					<div class="label">
						<span>{{rname}}{{#innate}}<span>, {{innate}}</span>{{/innate}}{{#attack}}
							<span>({{mod}})</span>{{/attack}}</span>
					</div>
					{{#charname}}
					<div class="charname">
						<span>{{charname}}</span>
					</div>
					{{/charname}}
				</div>
				{{/attack}}
				{{#desc}}
				<div class="desc info">
					<span>
						<span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
					</span>
				</div>
				{{/desc}}
				{{#globaldamage}}
				{{#^rollTotal() globaldamage 0}}
				<div class="desc">
					<span>
						{{globaldamage}}
						{{#attack}}
						{{#normal}}
						{{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}
						{{/normal}}
						{{#always}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/always}}
						{{#advantage}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> +
						</span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{/disadvantage}}
						{{/attack}}
					</span>
					<span class="sublabel">{{globaldamagetype}}</span>
				</div>
				{{/^rollTotal() globaldamage 0}}
				{{/globaldamage}}
				{{#hldmg}}
				{{#^rollTotal() hldmg 0}}
				<div class="desc">
					<span>
						{{hldmg}}
						{{#attack}}
						{{#normal}}
						{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}
						{{/normal}}
						{{#always}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/always}}
						{{#advantage}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{/disadvantage}}
						{{/attack}}
					</span>
					<span class="sublabel">{{dmg1type}}</span>
					<div class="label">
						<span>Higher Level Cast</span>
					</div>
				</div>
				{{/^rollTotal() hldmg 0}}
				{{/hldmg}}

				<div class="char-name">
					<span>{{charname}}</span>
				</div>

				{{#damage}}
				<div class="container damagetemplate">
					<div class="result">
						DAMAGE!!!!!!
						{{#dmg1flag}}
						{{^dmg2flag}}
						<div class="solo">
							<span class="damage">
								{{dmg1}}
								{{#attack}}
								{{#normal}}
								{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
								{{/normal}}
								{{#always}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/always}}
								{{#advantage}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/advantage}}
								{{#disadvantage}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{/disadvantage}}
								{{/attack}}
							</span>
							<span class="sublabel">{{dmg1type}}</span>
						</div>
						{{/dmg2flag}}
						{{/dmg1flag}}
						{{#dmg2flag}}
						{{^dmg1flag}}
						<div class="solo">
							<span class="damage">
								{{dmg2}}
								{{#attack}}
								{{#normal}}
								{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
								{{/normal}}
								{{#always}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/always}}
								{{#advantage}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/advantage}}
								{{#disadvantage}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{/disadvantage}}
								{{/attack}}
							</span>
							<span class="sublabel">{{dmg2type}}</span>
						</div>
						{{/dmg1flag}}
						{{/dmg2flag}}
						{{#dmg1flag}}
						{{#dmg2flag}}
						<div class="adv">
							<span class="damage">
								{{dmg1}}
								{{#attack}}
								{{#normal}}
								{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
								{{/normal}}
								{{#always}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/always}}
								{{#advantage}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/advantage}}
								{{#disadvantage}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{/disadvantage}}
								{{/attack}}
							</span>
							<span class="sublabel">{{dmg1type}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span>
								{{dmg2}}
								{{#attack}}
								{{#normal}}
								{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
								{{/normal}}
								{{#always}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/always}}
								{{#advantage}}
								{{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
								{{/advantage}}
								{{#disadvantage}}
								{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
								{{/disadvantage}}
								{{/attack}}
							</span>
							<span class="sublabel">{{dmg2type}}</span>
						</div>
						{{/dmg2flag}}
						{{/dmg1flag}}
					</div>
					{{^attack}}
					{{#range}}
					<div class="sublabel">
						<span>{{range}}</span>
					</div>
					{{/range}}
					<div class="label">
						<span>{{rname}}</span>{{#innate}}<span>, {{innate}}</span>{{/innate}}
					</div>
					{{#charname}}
					<div class="charname">
						<span>{{charname}}</span>
					</div>
					{{/charname}}
					{{/attack}}
				</div>
				{{/damage}}
			</rolltemplate>

			<rolltemplate class="sheet-rolltemplate-desc">
				<div class="desc info">
					<span>
						<span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
					</span>
				</div>
			</rolltemplate>

			<rolltemplate class="sheet-rolltemplate-dmg">
				<div class="sheet-container">
					<div class="char-name">
						<span>{{charname}}: {{rname}}</span>
					</div>
				</div>
				{{^attack}}
				{{#desc}}
				<div class="desc info">
					<span>
						<span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
					</span>
				</div>
				{{/desc}}
				{{/attack}}
				{{#hldmg}}
				{{#^rollTotal() hldmg 0}}
				<div class="desc">
					<span>{{hldmg}}{{#hldmgcrit}}<span class="plus"> + </span>{{hldmgcrit}}{{/hldmgcrit}}</span>
					<div class="label">
						<span>Higher Level Cast</span>
					</div>
				</div>
				{{/^rollTotal() hldmg 0}}
				{{/hldmg}}
				<div class="container damagetemplate">
					<div class="result">
						{{#dmg1flag}}
						{{^dmg2flag}}
						<div class="solo">
							<span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
						</div>
						{{/dmg2flag}}
						{{/dmg1flag}}
						{{#dmg2flag}}
						{{^dmg1flag}}
						<div class="solo">
							<span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
						</div>
						{{/dmg1flag}}
						{{/dmg2flag}}
						{{#dmg1flag}}
						{{#dmg2flag}}
						<div class="adv">
							<span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
						</div>
						{{/dmg2flag}}
						{{/dmg1flag}}
					</div>
					{{^attack}}
					{{#range}}
					<div class="sublabel" style="color: black;">
						<span>{{range}}</span>
					</div>
					{{/range}}
					<div class="label">
						<span>{{rname}}</span>{{#innate}}<span>, {{innate}}</span>{{/innate}}
					</div>
					{{/attack}}
				</div>
			</rolltemplate>

			<rolltemplate class="sheet-rolltemplate-npc">
				<div class="row header">
					<span>{{rname}}</span>
				</div>
				{{#name}}
				<div class="row subheader">
					<span class="italics">{{name}}</span>
				</div>
				{{/name}}
				<div class="arrow-right"></div>
				<div class="row">
					{{#normal}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span>
					{{/normal}}
					{{#always}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/always}}
					{{#advantage}}
					{{#rollLess() r1 r2}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/rollLess() r1 r2}}
					{{#rollTotal() r1 r2}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/rollTotal() r1 r2}}
					{{#rollGreater() r1 r2}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/rollGreater() r1 r2}}
					{{/advantage}}
					{{#disadvantage}}
					{{#rollLess() r1 r2}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/rollLess() r1 r2}}
					{{#rollTotal() r1 r2}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/rollTotal() r1 r2}}
					{{#rollGreater() r1 r2}}
					<span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
					{{/rollGreater() r1 r2}}
					{{/disadvantage}}
				</div>
			</rolltemplate>

			<rolltemplate class="sheet-rolltemplate-npcaction">
				<div class="container">
					<div class="row header">
						<span>{{rname}}</span>
					</div>
					{{#name}}
					<div class="row subheader">
						<span class="italics">{{name}}</span>
					</div>
					{{/name}}
					<div class="arrow-right"></div>
					{{#attack}}
					<div class="row">
						{{#normal}}
						<span class="italics">Attack: </span><span>{{r1}}</span>
						{{/normal}}
						{{#always}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/always}}
						{{#advantage}}
						{{#rollLess() r1 r2}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollLess() r1 r2}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
						{{/rollGreater() r1 r2}}
						{{/disadvantage}}
					</div>
					{{/attack}}
					{{#description}}
					<span class="desc">{{description}}</span>
					{{/description}}
				</div>
				{{#damage}}
				<div class="container dmgcontainer damagetemplate">
					<span class="italics">Damage: </span>
					<span>
						{{#dmg1flag}}
						{{dmg1}}
						{{#normal}}
						{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}
						{{/normal}}
						{{#always}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/always}}
						{{#advantage}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{/disadvantage}}
						{{dmg1type}}
						{{/dmg1flag}}
						{{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
						{{#dmg2flag}}
						{{dmg2}}
						{{#normal}}
						{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}
						{{/normal}}
						{{#always}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/always}}
						{{#advantage}}
						{{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
						{{/disadvantage}}
						{{dmg2type}}
						{{/dmg2flag}}
					</span>
				</div>
				{{/damage}}
			</rolltemplate>
			<rolltemplate class="sheet-rolltemplate-simple">
				<div class="sheet-container">
					<div class="char-name">
						<span>{{charname}}</span>
					</div>
					<div class="roll-name">
						<span>{{rname}}{{#mod}} <span>({{mod}})</span>{{/mod}}</span>
					</div>
					<div class="result">
						{{#normal}}
						<div class="solo">
							<span class="roll-used">{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRIT SUCCESS!</div>{{/rollWasCrit() r1}}
						{{#rollWasFumble() r1}}<div class="crit-fail">CRIT FAIL!</div>{{/rollWasFumble() r1}}
						{{/normal}}
						{{#advantage}}
						{{#rollLess() r1 r2}}
						<div class="adv">
							<span class="roll-unused">{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasCrit() r2}}<div class="crit-success">CRIT SUCCESS!</div>{{/rollWasCrit() r2}}
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRIT SUCCESS!</div>{{/rollWasCrit() r1}}
						{{#rollWasFumble() r1}}<div class="crit-fail">CRIT FAIL!</div>{{/rollWasFumble() r1}}
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-unused">{{r2}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRIT SUCCESS!</div>{{/rollWasCrit() r1}}
						{{/rollGreater() r1 r2}}
						{{/advantage}}
						{{#disadvantage}}
						{{#rollLess() r1 r2}}
						<div class="adv">
							<span class="roll-used">{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-unused">{{r2}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasFumble() r1}}<div class="crit-fail">CRIT FAIL!</div>{{/rollWasFumble() r1}}
						{{/rollLess() r1 r2}}
						{{#rollTotal() r1 r2}}
						<div class="adv">
							<span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasCrit() r1}}<div class="crit-success">CRIT SUCCESS!</div>{{/rollWasCrit() r1}}
						{{#rollWasFumble() r1}}<div class="crit-fail">CRIT FAIL!</div>{{/rollWasFumble() r1}}
						{{/rollTotal() r1 r2}}
						{{#rollGreater() r1 r2}}
						<div class="adv">
							<span class="roll-unused">{{r1}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						<div class="advspacer"></div>
						<div class="adv">
							<span class="roll-used">{{r2}}{{#global}} + {{global}}{{/global}}</span>
						</div>
						{{#rollWasFumble() r2}}<div class="crit-fail">CRIT FAIL!</div>{{/rollWasFumble() r2}}
						{{/rollGreater() r1 r2}}
						{{/disadvantage}}
					</div>
				</div>
			</rolltemplate>
			<rolltemplate class="sheet-rolltemplate-traits">
				<div class="sheet-container">
					<div class="char-name">
						{{charname}}
					</div>
					<div class="trait-name">
						{{name}}
					</div>
					{{#description}}
					<div class="trait-desc">
						{{description}}
					</div>
					{{/description}}
			</rolltemplate>
		</div>
	</div>
	<script type="text/worker">

		//////////
		/// required text for Shadowdark RPG Third-Party License Version 1.1:		
		/// "Roll20 Shadowdark RPG Character Sheet is an independent product published under the 
		/// Shadowdark RPG Third-Party License and is not affiliated with The Arcane Library, 
		/// LLC. Shadowdark RPG © 2023 The Arcane Library, LLC."
		///
		/// allowed content is using the rules and game mechanics as well as names of beings, locations, spells, and items
		/// verbatim text is restricted to monsters, spells, and magic items
		//////////

		// random fun
		pickRandom = (a) => { return a[Math.floor(Math.random() * a.length)] }
		rollSum = (n, d) => { return Array.from({length: n}, () => Math.floor(Math.random() * (d||6)) + 1).reduce((a, b) => a + b, 0) }
		
		const core_starting_gear = ["Torch", "Dagger", "Pole", "Shortbow + 5 arrows", "Rope (60')", "Oil flask", "Crowbar", "Iron spikes (10)", "Flint and steel", "Grappling hook", "Club", "Catrops (one bag)"];
		const core_stats = ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"];
		const core_ancestries = ["Human", "Halfling", "Elf", "Dwarf", "Goblin", "Half-Orc"];
		const core_backgrounds = ["Urchin", "Wanted", "Cult Initiate", "Thieves' Guild", "Banished", "Orphaned", "Wizard's Apprentice", "Jeweler", "Herbalist", "Barbarian", "Mercenary", "Sailor", "Acolyte", "Soldier", "Ranger", "Scout", "Minstrel", "Scholar", "Noble", "Chirurgeon"];
		const core_beliefs = [ 
			{ 
				alignment: "Good", 
				deities: ["Saint Terragnis", "Madeera the Covenant"] 
			},
			{
				alignment: "Chaotic",
				deities: ["Shune the Vile", "Memnon", "Ramlaat"]
			},
			{
				alignment: "Neutral",
				deities: ["Gede", "Ord"]
			}
		];

		on("clicked:randomlevelzero", function() {
			// prompt user to replace stats
			getAttrs(["levelzero_confirm_flag", "character_name"], function(v) {
				if (v.levelzero_confirm_flag !== "1") {
					console.log("You must accept the disclaimer before generating a level 0 PC.")
					return;
				}
				generate_level_zero(v.character_name);
			});
		});

		on("clicked:importmonster", function() {
			// prompt user to replace stats
			getAttrs(["levelzero_confirm_flag", "character_name", "json"], function(v) {
				if (v.levelzero_confirm_flag !== "1" || !v.json?.length) {
					console.log("You must accept the disclaimer and input some text before importing a monster.")
					return;
				}
				try {
					const monsterSheet = parseMonsterText(v.json);
					const isNpc = true;
					if (monsterSheet) import_sheet(monsterSheet, isNpc);
				}
				catch(ex)
				{
					console.log("Monster import failed.");
					console.log(ex);
				}
			});
		});

		on("clicked:importjson", function() {
			// prompt user to replace stats
			getAttrs(["levelzero_confirm_flag", "character_name", "json"], function(v) {
				if (v.levelzero_confirm_flag !== "1" || !v.json?.length) {
					console.log("You must accept the disclaimer and input some JSON before importing a sheet.")
					return;
				}
				try {
					const importedSheetObj = JSON.parse(v.json);
					const isNpc = false; // Shadowdarklings supports only crawlers for now
					if(!importedSheetObj) return;
					import_sheet(importedSheetObj, isNpc);
				}
				catch(ex)
				{
					console.log("Sheet import failed.");
					console.log(ex);
				}
			});
		});		

		let parseMonsterText = function parseMonsterText(monsterText) {
			const alignments = {};
			alignments["C"] = "Chaotic";
			alignments["L"] = "Lawful";
			alignments["N"] = "Neutral";
			let lines = monsterText.trim().split(/[\n]+/);
			// Find the first line containing the monster name
			const name = lines[0].trim();
			if (!name?.length) {
				console.log("No monster name found.");
				return null;
			}
		
			const monster = {
				name: name,
				description: "",
				stats: {}
			};
			
			let acLine = 0;
			
			// Iterate through the lines to extract relevant information
			for (let i = 1; i < lines.length; i++) {
				const line = lines[i].trim(); // Trim leading and trailing whitespace for copy-paste issues	
				if(!line?.length) continue; // skip dem empty lines
				
				// Assume AC is first stat. Everything between name and AC is Description text.
				// Hopefully there is no monster with "AC " in the description... shrug..
				if(!monster.stats.AC && !line.startsWith('AC ')) {
					if (monster.description.length) monster.description += " ";
					monster.description += line;
				}
				else {
					acLine = i;
					break;
				}
			}
			
			lines = lines.slice(acLine).join(" ").split(",");
			for (let i = 0; i < lines.length; i++) {
				const line = lines[i].trim(); // Trim leading and trailing whitespace for copy-paste issues	
				if(!line?.length) continue; // skip dem empty lines
				try {
					if (!monster.armorClass && line.startsWith('AC ')) {
						const [, AC, armor] = line.match(/AC (\d+)(?: \(([\w\s]+)\))?/);
						monster.armorClass = +AC;
						monster.armor = armor || "";
					} else if (!monster.maxHitPoints && line.startsWith('HP ')) {
						const [, HP] = line.match(/HP (\d+)/);
						monster.maxHitPoints = +HP;
					} else if (line.startsWith('ATK ')) {
						const [, attacks] = line.match(/ATK (.+)/);
						const attackArray = attacks.split(',').map(attack => attack.trim());
						monster.stats.attacks = attackArray;
					} else if (!monster.stats.movement && line.startsWith('MV ')) {
						monster.stats.movement = line.substring(3);
					} else if (!monster.stats.str_mod && line.startsWith('S ')) {
						monster.stats.str_mod = parseInt(line.substring(2));
					} else if (!monster.stats.dex_mod && line.startsWith('D ')) {
						monster.stats.dex_mod = parseInt(line.substring(2));
					} else if (!monster.stats.con_mod && line.startsWith('C ')) {
						monster.stats.con_mod = parseInt(line.substring(2));
					} else if (!monster.stats.int_mod && line.startsWith('I ')) {
						monster.stats.int_mod = parseInt(line.substring(2));
					} else if (!monster.stats.wis_mod && line.startsWith('W ')) {
						monster.stats.wis_mod = parseInt(line.substring(2));
					} else if (!monster.stats.cha_mod && line.startsWith('Ch ')) {
					monster.stats.cha_mod = parseInt(line.substring(3));
					} else if (!monster.alignment && line.startsWith('AL ')) {
						monster.alignment = alignments[line.substring(3)];
					} else if (!monster.level && line.startsWith('LV ')) {
						monster.level = parseInt(line.substring(3));
						break; // done getting stats - get attack text next loop
					}
				}
				catch(ex) { console.log(ex); }
			}
			return monster;
		}

		let import_sheet = function(sheet, isNpc) {
			console.log("Importing custom sheet:\n" + JSON.stringify(sheet));
			// set core stats, attributes, and non-repeater items.
			let update = {
				npc: isNpc ? "1" : "0",
				levelzero_confirm_flag: "0", // clear flag to prevent accidental wipes
				character_name: sheet.name || "Nameless One",
				xp: sheet.XP || 0,
				base_level: sheet.level || 0,
				lifetime_xp: getTotalXpForLevel(sheet.level || 0) + (sheet.XP || 0),
				xp_nextlevel: sheet.level < 1 || sheet.level >= 10 ? 0 : sheet.level * 10,
				movement: sheet.stats?.movement || "",
				description: sheet.description || "",
				armor: sheet.armor || "",
				class: sheet.class || "",
				title: sheet.title || "",
				ancestry: sheet.ancestry || "",
				background: sheet.background || "",
				alignment: sheet.alignment || "",
				deity: sheet.deity || "",
				hp: sheet.maxHitPoints || 0,
				hp_max: sheet.maxHitPoints || 0,
				ac: sheet.armorClass || 10,
				strength: sheet.stats?.STR || 10,
				dexterity: sheet.stats?.DEX || 10,
				constitution: sheet.stats?.CON || 10,
				intelligence: sheet.stats?.INT || 10,
				wisdom: sheet.stats?.WIS || 10,
				charisma: sheet.stats?.CHA || 10,
				strength_base: sheet.stats?.STR || 10,
				dexterity_base: sheet.stats?.DEX || 10,
				constitution_base: sheet.stats?.CON || 10,
				intelligence_base: sheet.stats?.INT || 10,
				wisdom_base: sheet.stats?.WIS || 10,
				charisma_base: sheet.stats?.CHA || 10,
				strength_mod: sheet.stats.str_mod || Math.max(4, Math.floor(((sheet.stats?.STR || 10) - 10) / 2)),
				dexterity_mod: sheet.stats.dex_mod || Math.max(4, Math.floor(((sheet.stats?.DEX || 10) - 10) / 2)),
				constitution_mod: sheet.stats.con_mod || Math.max(4, Math.floor(((sheet.stats?.CON || 10) - 10) / 2)),
				intelligence_mod: sheet.stats.int_mod || Math.max(4, Math.floor(((sheet.stats?.INT || 10) - 10) / 2)),
				wisdom_mod: sheet.stats.wis_mod || Math.max(4, Math.floor(((sheet.stats?.WIS || 10) - 10) / 2)),
				charisma_mod: sheet.stats.cha_mod || Math.max(4, Math.floor(((sheet.stats?.CHA || 10) - 10) / 2)),
				slots_max: sheet.gearSlotsTotal || 10,
				slots: sheet.gearSlotsUsed || 0,
				gp: sheet.gold || 0,
				sp: sheet.silver || 0,
				cp: sheet.copper || 0
			};

			// add imported gear
			let slotGear = [];
			let noSlotGear = [];
			if (sheet.gear?.length) {
				try {
					slotGear = sheet.gear
						.filter(o => o.slots > 0 && o.quantity > 0)
						.flatMap((o) => {
							if (o.slots > 1 && o.quantity <= o.slots)
							{
								// fill by slots (will include "big" items taking > 1 slot)
								return new Array(o.slots).fill(o.name);
							}
							else if ((o.totalUnits && o.totalUnits > 1) || o.quantity > o.slots)
							{
								// account for stackables like ammo where qty > slots
								// if only 1 piece of ammo, no worries. it is handled below.
								// first version: if more than 1 slot, then divide stacks ~equally. don't care about hardcoding arbitrary stack size rules.
								let totalUnits = o.totalUnits || o.quantity;
								const stackSize = Math.floor(totalUnits / o.slots);
								const stacks = new Array(o.slots);
								while (totalUnits > 0) {
									stackQty = totalUnits -= Math.min(totalUnits, stackSize);
									stacks.push(o.name + " (" + o.totalUnits + ")");
								}
								return stacks;
							}
							// fall back to fill by qty
							return new Array(o.quantity).fill(o.name);
						});
					noSlotGear = sheet.gear
						.filter(o=> o.slots === 0)
						.map(o=>o.name + " ("+o.quantity+")");

					// shove magic items and treasures in no slot gear with details, and add slot it used.
					if (sheet.treasures?.length) {
						noSlotGear = noSlotGear.concat(sheet.treasures.map(o=> {
							const sb = [o.name];
							if(o.desc?.length) sb.push(": " + o.desc);
							if(o.cost && o.currency) sb.push("\n" + o.cost + " " + o.currency);
							if (o.slots)
							{
								sb.push(" ("+ o.slots + " slot" + (o.slots > 1 ? "s" : "") + ")");
								slotGear = slotGear.concat(new Array(o.slots).fill(o.name));
							}
							return sb.join("");
						}));
					}
					if (sheet.magicItems?.length) {
						noSlotGear = noSlotGear.concat(sheet.magicItems.map(o=> {
							const sb = [o.name];
							if(o.features?.length) sb.push(": " + o.features);

							// as of 15 Jan 2024, Shadowdarklings has a bug where magic items don't include slot count in JSON. assume 1 slot until fixed. probably matters only for armor. (reported bug via discord)
							let slots = o.slots || 1;
							sb.push(" ("+ slots + " slot" + (slots > 1 ? "s" : "") + ")");
							slotGear = slotGear.concat(new Array(slots).fill(o.name));

							if(o.bonus) sb.push("\nBonus: " + o.bonus);
							if(o.bonusNote?.length) sb.push("\n" + o.bonusNote);
							if(o.attackNote?.length) sb.push("\n" + o.attackNote);
							if(o.benefits?.length) sb.push("\nBenefits: " + o.benefits);
							if(o.curses?.length) sb.push("\nCurses: " + o.curses);
							if(o.hasPersonality) sb.push("\nPersonality:");
							if(o.personalityVirtue?.length) sb.push("\nVirtues: " + o.personalityVirtue);
							if(o.personalityFlaws?.length) sb.push("\nFlaws: " + o.personalityFlaws);
							if(o.personalityTraits?.length) sb.push("\nTraits: " + o.personalityTraits);
							return sb.join("");
						}));
					}
					update["gearnoslots"] = noSlotGear.join("\n\n");
				}
				catch(ex)
				{
					console.log("Sorry, but there was a problem parsing gear from this custom sheet. Can you clean it up or make it simpler, and try again?");
				}
			}
			for (let i = 0; i < 22; ++i)
			{
				update["gearslot" + (i + 1)] = slotGear[i] || "";
			}

			// update derived stats
			update["initiative_bonus"] = +update["dexterity_mod"];

			setAttrs(update, {
				silent: true
			});
			update_slots(sheet.gearSlotsTotal);
			console.log("Finished importing custom sheet");
		}

		let generate_level_zero = function(name) {
			console.log("Rolling a new Level 0 PC...");
			let belief = pickRandom(core_beliefs);
			let update = {
				npc: "0",
				xp: 0,
				base_level: 0,
				lifetime_xp: 0,
				xp_nextlevel: 0,
				class: "Level 0",
				armor: "",
				title: "",
				ancestry: pickRandom(core_ancestries),
				background: pickRandom(core_backgrounds),
				alignment: belief.alignment,
				deity: pickRandom(belief.deities)
			};

			// roll 3d6 for each stat. Enforce optional rule: reroll if no stat exceeds 14.
			const minFavoredStat = 14;
			let stats = [];
			while(true) {
				stats = Array.from({length: core_stats.length}, () => rollSum(3, 6));
				console.log("Rolled stats: " + stats);
				if (Math.max(...stats) < minFavoredStat)
				{
					console.log("Ouch! Not a single stat below " + minFavoredStat + ". Re-rolling to be nice.");
				}
				else break;
			}

			// assign rolls to stats and set modifiers
			core_stats.forEach((stat, idx) => {
				let val = stats[idx];
				let mod = Math.floor((val - 10) / 2);
				update[stat + "_base"] = val;
				update[stat] = val;
				update[stat + "_mod"] = mod;
			});

			// HP = Con mod + 1
			let hp = Math.max(1, update["constitution_mod"]);
			update["hp"] = hp;
			update["hp_max"] = hp;

			// start with 1d4 common gear
			let gearQty = rollSum(1, 4);
			let gear = Array.from({length: gearQty}, () => pickRandom(core_starting_gear));
			console.log("Starting Gear: " + gear.join(', '));
			for (let i = 0; i < 22; ++i)
			{
				update["gearslot" + (i + 1)] = gear[i] || "";
			}

			// update derived stats
			// AC = 10 + Dex mod
			// Slots Capacity = max of Strength stat or 10
			update["initiative_bonus"] = +update["dexterity_mod"];
			update["ac"] = 10 + +update["dexterity_mod"];
			let totalSlots = Math.max(10, update["strength"]);
			update["slots_max"] = totalSlots;
			update["slots"] = gearQty;

			setAttrs(update, {
				silent: true
			});

			update_slots(totalSlots);

			console.log("Finished rolling new Level 0 PC");
			const msg = "Rolled a new random Level 0 PC for " + name + ". Nice stats! " + stats;
			startRoll(msg, (results) => {
				finishRoll(results.rollId);
			});
		}

		core_stats.forEach(attr => {
			on(`change:${attr}_base change:${attr}_bonus`, function() {
				update_attr(`${attr}`);
			});
		});

		core_stats.forEach(attr => {
			on(`change:${attr}`, function() {
				update_mod(`${attr}`);

				const cap = attr.charAt(0).toUpperCase() + attr.slice(1);

				// (attr === "strength") ? update_weight(): false;
				(attr === "dexterity") ? update_initiative(): false;
			});
		});

		core_stats.forEach(attr => {
			on(`change:${attr}_mod`, function() {
				update_attacks(`${attr}`);
				switch (`${attr}`) {
					case "strength":
						break;
					case "dexterity":
						update_initiative();
						break;
					case "intelligence":
						break;
					case "wisdom":
						break;
					case "charisma":
						break;
					default:
						false;
				}
			});
		});

		on("change:repeating_attack:atkname change:repeating_attack:atkflag change:repeating_attack:atkattr_base change:repeating_attack:atkmod change:repeating_attack:atkmagic change:repeating_attack:atkprofflag change:repeating_attack:dmgflag change:repeating_attack:dmgbase change:repeating_attack:dmgmod change:repeating_attack:dmgtype change:repeating_attack:dmg2flag change:repeating_attack:dmg2base change:repeating_attack:dmg2mod change:repeating_attack:dmg2type change:repeating_attack:dmgcustcrit change:repeating_attack:dmg2custcrit change:repeating_attack:castdc change:repeating_attack:duration change:repeating_attack:atkrange", function(eventinfo) {
			if (eventinfo.sourceType === "sheetworker") {
				return;
			}
			var source = eventinfo.sourceAttribute.substr(38);
			var attackid = eventinfo.sourceAttribute.substring(17, 37);
			update_attacks(attackid);
		});
		
		on("change:repeating_inventory:itemcontainer change:repeating_inventory:equipped change:repeating_inventory:carried change:repeating_inventory:itemweight change:repeating_inventory:itemcount change:cp change:sp change:ep change:gp change:pp change:currency_other change:encumberance_setting change:size change:carrying_capacity_mod change:use_inventory_slots change:inventory_slots_mod change:repeating_inventory:itemweightfixed change:repeating_inventory:itemslotsfixed change:repeating_inventory:itemsize change:repeating_inventory:itemcontainer_slots_modifier", function() {
			// todo: compute slots for GP and SP etc ? priority = low
			//update_weight();
		});

		on("change:base_level", function(eventinfo) {
			if (eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {
				return;
			}
			console.log(eventinfo);
			let level = parseInt(+eventinfo.newValue, 10) || 0;
			let oldLevel = parseInt(+eventinfo.previousValue, 10) || 0;
			set_level(level, oldLevel);
		});

		on("change:initmod change:init_tiebreaker", function(eventinfo) {
			if (eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {
				return;
			}
			update_initiative();
		});
		
		on("change:slots_max", function(eventinfo) {
			// disable gear slots input based on slot capacity
			if (eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {
				return;
			}
			update_slots(eventinfo.newValue);
		});

		let update_slots = function(totalSlots) {
			let update = {};
			// Min slots = 10; Slots = STR score (which can exceed 18) + Fighter can use CON mod
			// Stats can go higher than 18 so it is possible (but improbable) a PC could exceed 22 slots. meh, use the treasure box for overflow.
			const maxSheetSlots = 22;
			const minPcSlots = 10;
			const maxPcSlots = Math.max(minPcSlots, parseInt(totalSlots, 10) || minPcSlots);
			if (totalSlots < minPcSlots) update["slotsmaximum"] = minPcSlots;
			// roll20 doesn't let you directly mess with disabled properties (I think. I tried.)
			// instead, created separate checkbox for each slot which triggers CSS rule to disable it. oof.
			for (let i = 1; i <= maxSheetSlots; ++i) {
				let attrName = "gearslot" + i + "enabled";
				update[attrName] = i <= maxPcSlots ? "1" : "0";
			}
			setAttrs(update);
		}

		on("change:repeating_npcaction:attack_flag change:repeating_npcaction:attack_type change:repeating_npcaction:attack_range change:repeating_npcaction:attack_target change:repeating_npcaction:attack_tohit change:repeating_npcaction:attack_damage change:repeating_npcaction:attack_damagetype change:repeating_npcaction:attack_damage2 change:repeating_npcaction:attack_damagetype2 change:repeating_npcaction-l:attack_flag change:repeating_npcaction-l:attack_type change:repeating_npcaction-l:attack_range change:repeating_npcaction-l:attack_target change:repeating_npcaction-l:attack_tohit change:repeating_npcaction-l:attack_damage change:repeating_npcaction-l:attack_damagetype change:repeating_npcaction-l:attack_damage2 change:repeating_npcaction-l:attack_damagetype2 change:repeating_npcaction:show_desc change:repeating_npcaction-l:show_desc change:repeating_npcaction:description change:repeating_npcaction-l:description", function(eventinfo) {
			var actionid = eventinfo.sourceAttribute.substring(20, 40);
			var legendary = eventinfo.sourceAttribute.indexOf("npcaction-l") > -1 ? true : false;
			if (legendary) {
				actionid = eventinfo.sourceAttribute.substring(22, 42);
			}
			update_npc_action(actionid, legendary);
		});

		var update_attr = function(attr) {
			var update = {};
			var attr_fields = [attr + "_base", attr + "_bonus"];
			getSectionIDs("repeating_inventory", function(idarray) {
				_.each(idarray, function(currentID, i) {
					attr_fields.push("repeating_inventory_" + currentID + "_equipped");
					attr_fields.push("repeating_inventory_" + currentID + "_itemmodifiers");
				});
				getAttrs(attr_fields, function(v) {
					var base = v[attr + "_base"] && !isNaN(parseInt(v[attr + "_base"], 10)) ? parseInt(v[attr + "_base"], 10) : 10;
					var bonus = v[attr + "_bonus"] && !isNaN(parseInt(v[attr + "_bonus"], 10)) ? parseInt(v[attr + "_bonus"], 10) : 0;
					var item_base = 0;
					var item_bonus = 0;
					_.each(idarray, function(currentID) {
						if ((!v["repeating_inventory_" + currentID + "_equipped"] || v["repeating_inventory_" + currentID + "_equipped"] === "1") && v["repeating_inventory_" + currentID + "_itemmodifiers"] && v["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().indexOf(attr > -1)) {
							var mods = v["repeating_inventory_" + currentID + "_itemmodifiers"].toLowerCase().split(",");
							_.each(mods, function(mod) {
								if (mod.indexOf(attr) > -1) {
									if (mod.indexOf(":") > -1) {
										var new_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
										item_base = new_base && new_base > item_base ? new_base : item_base;
									} else if (mod.indexOf("-") > -1) {
										var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
										item_bonus = new_mod ? item_bonus - new_mod : item_bonus;
									} else {
										var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
										item_bonus = new_mod ? item_bonus + new_mod : item_bonus;
									}
								};
							});
						}
					});

					update[attr + "_flag"] = bonus != 0 || item_bonus > 0 || item_base > base ? 1 : 0;
					base = base > item_base ? base : item_base;
					update[attr] = base + bonus + item_bonus;
					setAttrs(update);
				});
			});
		};

		var update_mod = function(attr) {
			getAttrs([attr], function(v) {
				var attr_abr = attr.substring(0, 3);
				// per SD rules attributes can exceed 18 but mods can"t exceed +4
				const modMax = 4;
				var finalattr = v[attr] && isNaN(v[attr]) === false ? Math.floor((parseInt(v[attr], 10) - 10) / 2) : 0;
				var update = {};
				update[attr + "_mod"] = Math.min(modMax, finalattr);
				update["npc_" + attr_abr + "_negative"] = v[attr] && !isNaN(v[attr]) && parseInt(v[attr], 10) < 10 ? 1 : 0;
				setAttrs(update);
			});
		};

		var create_attack_from_item = function(itemid, options) {
			var update = {};
			var newrowid = generateRowID();
			update["repeating_inventory_" + itemid + "_itemattackid"] = newrowid;
			if (options && options.versatile) {
				var newrowid2 = generateRowID();
				update["repeating_inventory_" + itemid + "_itemattackid"] += "," + newrowid2;
				setAttrs(update, {}, function() {
					update_attack_from_item(itemid, newrowid, {
						newattack: true,
						versatile: "primary"
					});
					update_attack_from_item(itemid, newrowid2, {
						newattack: true,
						versatile: "secondary"
					});
				});
			} else {
				setAttrs(update, {}, update_attack_from_item(itemid, newrowid, {
					newattack: true
				}));
			}
		};
		
		var update_attacks = function(update_id, source) {
			console.log("DOING UPDATE_ATTACKS: " + update_id);
			if (update_id.substring(0, 1) === "-" && update_id.length === 20) {
				do_update_attack([update_id], source);
			} else if (["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "spells", "all"].indexOf(update_id) > -1) {
				getSectionIDs("repeating_attack", function(idarray) {
					if (update_id === "all") {
						do_update_attack(idarray);
					} else if (update_id === "spells") {
						var attack_attribs = [];
						_.each(idarray, function(id) {
							attack_attribs.push("repeating_attack_" + id + "_spellid", "repeating_attack_" + id + "_spelllevel");
						});
						getAttrs(attack_attribs, function(v) {
							var filteredIds = _.filter(idarray, function(id) {
								return v["repeating_attack_" + id + "_spellid"] && v["repeating_attack_" + id + "_spellid"] != "";
							});
							var spell_attacks = {};
							_.each(filteredIds, function(attack_id) {
								spell_attacks[attack_id] = {
									spell_id: v["repeating_attack_" + attack_id + "_spellid"],
									spell_lvl: v["repeating_attack_" + attack_id + "_spelllevel"]
								};
							});
							_.each(spell_attacks, function(data, attack_id) {
								update_attack_from_spell(data.spell_lvl, data.spell_id, attack_id);
							});
						});

					} else {
						var attack_attribs = ["spellcasting_ability"];
						_.each(idarray, function(id) {
							attack_attribs.push("repeating_attack_" + id + "_atkattr_base");
						});
						getAttrs(attack_attribs, function(v) {
							var attr_attack_ids = [];
							_.each(idarray, function(id) {
								if ((v["repeating_attack_" + id + "_atkattr_base"] && v["repeating_attack_" + id + "_atkattr_base"].indexOf(update_id) > -1)) {
									attr_attack_ids.push(id);
								}
							});
							if (attr_attack_ids.length > 0) {
								do_update_attack(attr_attack_ids);
							}
						});
					};
				});
			};
		};

		var do_update_attack = function(attack_array, source) {
			var attack_attribs = ["level", "d20", "pbd_safe", "globalmagicmod", "strength_mod", "dexterity_mod", "constitution_mod", "intelligence_mod", "wisdom_mod", "charisma_mod", "global_damage_mod_roll", "global_damage_mod_crit"];
			_.each(attack_array, function(attackid) {
				attack_attribs.push("repeating_attack_" + attackid + "_atkflag");
				attack_attribs.push("repeating_attack_" + attackid + "_atkname");
				attack_attribs.push("repeating_attack_" + attackid + "_atkattr_base");
				attack_attribs.push("repeating_attack_" + attackid + "_atkmod");
				attack_attribs.push("repeating_attack_" + attackid + "_atkprofflag");
				attack_attribs.push("repeating_attack_" + attackid + "_atkmagic");
				attack_attribs.push("repeating_attack_" + attackid + "_dmgflag");
				attack_attribs.push("repeating_attack_" + attackid + "_dmgbase");
				attack_attribs.push("repeating_attack_" + attackid + "_dmgmod");
				attack_attribs.push("repeating_attack_" + attackid + "_dmgtype");
				attack_attribs.push("repeating_attack_" + attackid + "_dmg2flag");
				attack_attribs.push("repeating_attack_" + attackid + "_dmg2base");
				attack_attribs.push("repeating_attack_" + attackid + "_dmg2mod");
				attack_attribs.push("repeating_attack_" + attackid + "_dmg2type");
				attack_attribs.push("repeating_attack_" + attackid + "_dmgcustcrit");
				attack_attribs.push("repeating_attack_" + attackid + "_dmg2custcrit");
				attack_attribs.push("repeating_attack_" + attackid + "_hldmg");
				attack_attribs.push("repeating_attack_" + attackid + "_spellid");
				attack_attribs.push("repeating_attack_" + attackid + "_spelllevel");
				attack_attribs.push("repeating_attack_" + attackid + "_atkrange");
				attack_attribs.push("repeating_attack_" + attackid + "_itemid");
				attack_attribs.push("repeating_attack_" + attackid + "_duration");
				attack_attribs.push("repeating_attack_" + attackid + "_castdc");
				attack_attribs.push("repeating_attack_" + attackid + "_global_damage_mod_field");
			});

			getAttrs(attack_attribs, function(v) {
				_.each(attack_array, function(attackid) {
					var callbacks = [];
					var update = {};
					var hbonus = "";
					var hdmg1 = "";
					var hdmg2 = "";
					var dmg = "";
					var dmg2 = "";
					var rollbase = "";
					var spellattack = false;
					var magicattackmod = 0;
					var atkattr_abrev = "";
					var pbd_safe = v["pbd_safe"] ? v["pbd_safe"] : "";
					var global_crit = v["repeating_attack_" + attackid + "_global_damage_mod_field"] && v["repeating_attack_" + attackid + "_global_damage_mod_field"] != "" ? "@{global_damage_mod_crit}" : "";
					var hldmgcrit = v["repeating_attack_" + attackid + "_hldmg"] && v["repeating_attack_" + attackid + "_hldmg"] != "" ? v["repeating_attack_" + attackid + "_hldmg"].slice(0, 7) + "crit" + v["repeating_attack_" + attackid + "_hldmg"].slice(7) : "";
					if (v["repeating_attack_" + attackid + "_spellid"] && v["repeating_attack_" + attackid + "_spellid"] != "") {
						spellattack = true;
						magicattackmod = v["spell_attack_mod"] && !isNaN(parseInt(v["spell_attack_mod"], 10)) ? parseInt(v["spell_attack_mod"], 10) : 0;
					};

					if (!v["repeating_attack_" + attackid + "_atkattr_base"] || v["repeating_attack_" + attackid + "_atkattr_base"] === "0") {
						atkattr_base = 0
					} else if (v["repeating_attack_" + attackid + "_atkattr_base"] && v["repeating_attack_" + attackid + "_atkattr_base"] === "spell") {
						atkattr_base = parseInt(v[v["spellcasting_ability"].substring(2, v["spellcasting_ability"].length - 2)], 10);
						atkattr_abrev = v["spellcasting_ability"].substring(2, 5).toUpperCase();
					} else {
						atkattr_base = parseInt(v[v["repeating_attack_" + attackid + "_atkattr_base"].substring(2, v["repeating_attack_" + attackid + "_atkattr_base"].length - 1)], 10);
						atkattr_abrev = v["repeating_attack_" + attackid + "_atkattr_base"].substring(2, 5).toUpperCase();
					};

					var dmgbase = v["repeating_attack_" + attackid + "_dmgbase"] && v["repeating_attack_" + attackid + "_dmgbase"] != "" ? v["repeating_attack_" + attackid + "_dmgbase"] : 0;
					var dmg2base = v["repeating_attack_" + attackid + "_dmg2base"] && v["repeating_attack_" + attackid + "_dmg2base"] != "" ? v["repeating_attack_" + attackid + "_dmg2base"] : 0;
					var dmgmod = v["repeating_attack_" + attackid + "_dmgmod"] && isNaN(parseInt(v["repeating_attack_" + attackid + "_dmgmod"], 10)) === false ? parseInt(v["repeating_attack_" + attackid + "_dmgmod"], 10) : 0;
					var dmg2mod = v["repeating_attack_" + attackid + "_dmg2mod"] && isNaN(parseInt(v["repeating_attack_" + attackid + "_dmg2mod"], 10)) === false ? parseInt(v["repeating_attack_" + attackid + "_dmg2mod"], 10) : 0;
					var dmgtype = v["repeating_attack_" + attackid + "_dmgtype"] ? v["repeating_attack_" + attackid + "_dmgtype"] + " " : "";
					var dmg2type = v["repeating_attack_" + attackid + "_dmg2type"] ? v["repeating_attack_" + attackid + "_dmg2type"] + " " : "";
					var pb = v["repeating_attack_" + attackid + "_atkprofflag"] && v["repeating_attack_" + attackid + "_atkprofflag"] != 0 && v.pb ? v.pb : 0;
					var atkmod = v["repeating_attack_" + attackid + "_atkmod"] && v["repeating_attack_" + attackid + "_atkmod"] != "" ? parseInt(v["repeating_attack_" + attackid + "_atkmod"], 10) : 0;
					var atkmag = v["repeating_attack_" + attackid + "_atkmagic"] && v["repeating_attack_" + attackid + "_atkmagic"] != "" ? parseInt(v["repeating_attack_" + attackid + "_atkmagic"], 10) : 0;
					var dmgmag = isNaN(atkmag) === false && atkmag != 0 && ((v["repeating_attack_" + attackid + "_dmgflag"] && v["repeating_attack_" + attackid + "_dmgflag"] != 0) || (v["repeating_attack_" + attackid + "_dmg2flag"] && v["repeating_attack_" + attackid + "_dmg2flag"] != 0)) ? "+ " + atkmag + " Magic Bonus" : "";
					if (v["repeating_attack_" + attackid + "_atkflag"] && v["repeating_attack_" + attackid + "_atkflag"] != 0) {
						bonus_mod = atkattr_base + atkmod + atkmag + magicattackmod;
						if (v["pb_type"] && v["pb_type"] === "die") {
							plus_minus = bonus_mod > -1 ? "+" : "";
							bonus = bonus_mod + "+" + pb;
						} else {
							bonus_mod = bonus_mod + parseInt(pb, 10);
							plus_minus = bonus_mod > -1 ? "+" : "";
							bonus = plus_minus + bonus_mod;
						};
					} else {
						bonus = "-";
					}
					if (v["repeating_attack_" + attackid + "_dmgflag"] && v["repeating_attack_" + attackid + "_dmgflag"] != 0) {
						if (spellattack === true && dmgbase.indexOf("[[round((@{level} + 1) / 6 + 0.5)]]") > -1) {
							// SPECIAL CANTRIP DAMAGE
							dmgdiestring = Math.round(((parseInt(v["level"], 10) + 1) / 6) + 0.5).toString()
							dmg = dmgdiestring + dmgbase.substring(dmgbase.lastIndexOf("d"));
							if (dmgmod != 0) {
								dmg = dmg + "+" + dmgmod;
							}
							dmg = dmg + " " + dmgtype;
						} else {
							if (dmgbase === 0 && dmgmod === 0) {
								dmg = 0;
							}
							if (dmgbase != 0) {
								dmg = dmgbase;
							}
							if (dmgbase != 0 && dmgmod != 0) {
								dmg = dmgmod > 0 ? dmg + "+" : dmg;
							}
							if (dmgmod != 0) {
								dmg = dmg + dmgmod;
							}
							dmg = dmg + " " + dmgtype;
						}
					} else {
						dmg = "";
					};
					if (v["repeating_attack_" + attackid + "_dmg2flag"] && v["repeating_attack_" + attackid + "_dmg2flag"] != 0) {
						if (dmg2base === 0 && dmg2mod === 0) {
							dmg2 = 0;
						}
						if (dmg2base != 0) {
							dmg2 = dmg2base;
						}
						if (dmg2base != 0 && dmg2mod != 0) {
							dmg2 = dmg2mod > 0 ? dmg2 + "+" : dmg2;
						}
						if (dmg2mod != 0) {
							dmg2 = dmg2 + dmg2mod;
						}
						dmg2 = dmg2 + " " + dmg2type;
					} else {
						dmg2 = "";
					};
					dmgspacer = v["repeating_attack_" + attackid + "_dmgflag"] && v["repeating_attack_" + attackid + "_dmgflag"] != 0 && v["repeating_attack_" + attackid + "_dmg2flag"] && v["repeating_attack_" + attackid + "_dmg2flag"] != 0 ? "+ " : "";
					crit1 = v["repeating_attack_" + attackid + "_dmgcustcrit"] && v["repeating_attack_" + attackid + "_dmgcustcrit"] != "" ? v["repeating_attack_" + attackid + "_dmgcustcrit"] : dmgbase;
					crit2 = v["repeating_attack_" + attackid + "_dmg2custcrit"] && v["repeating_attack_" + attackid + "_dmg2custcrit"] != "" ? v["repeating_attack_" + attackid + "_dmg2custcrit"] : dmg2base;
					r1 = v["repeating_attack_" + attackid + "_atkflag"] && v["repeating_attack_" + attackid + "_atkflag"] != 0 ? "@{d20}" : "0d20";
					r2 = v["repeating_attack_" + attackid + "_atkflag"] && v["repeating_attack_" + attackid + "_atkflag"] != 0 ? "@{rtype}" : "{{r2=[[0d20";
					if (v["repeating_attack_" + attackid + "_atkflag"] && v["repeating_attack_" + attackid + "_atkflag"] != 0) {
						if (magicattackmod != 0) {
							hbonus = " + " + magicattackmod + "[SPELLATK]" + hbonus
						};
						if (atkmag != 0) {
							hbonus = " + " + atkmag + "[MAGIC]" + hbonus
						};
						if (pb != 0) {
							hbonus = " + " + pb + pbd_safe + "[PROF]" + hbonus
						};
						if (atkmod != 0) {
							hbonus = " + " + atkmod + "[MOD]" + hbonus
						};
						if (atkattr_base != 0) {
							hbonus = " + " + atkattr_base + "[" + atkattr_abrev + "]" + hbonus
						};
					} else {
						hbonus = "";
					}
					if (v["repeating_attack_" + attackid + "_dmgflag"] && v["repeating_attack_" + attackid + "_dmgflag"] != 0) {
						if (atkmag != 0) {
							hdmg1 = " + " + atkmag + "[MAGIC]" + hdmg1
						};
						if (dmgmod != 0) {
							hdmg1 = " + " + dmgmod + "[MOD]" + hdmg1
						};
						hdmg1 = dmgbase + hdmg1;
					} else {
						hdmg1 = "0";
					}
					if (v["repeating_attack_" + attackid + "_dmg2flag"] && v["repeating_attack_" + attackid + "_dmg2flag"] != 0) {
						if (dmg2mod != 0) {
							hdmg2 = " + " + dmg2mod + "[MOD]" + hdmg2
						};
						hdmg2 = dmg2base + hdmg2;
					} else {
						hdmg2 = "0";
					}
					var globaldamage = `[[${v.global_damage_mod_roll && v.global_damage_mod_roll !== "" ? v.global_damage_mod_roll : "0"}]]`;
					var globaldamagecrit = `[[${v.global_damage_mod_crit && v.global_damage_mod_crit !== "" ? v.global_damage_mod_crit : "0"}]]`;
					if (v["repeating_attack_" + attackid + "_atkflag"] && v["repeating_attack_" + attackid + "_atkflag"] != 0) {
						pickbase = "pick";
						rollbase = "@{wtype}&{template:atk} {{mod=@{atkbonus}}} {{rname=[@{atkname}](~repeating_attack_attack_dmg)}} {{rnamec=[@{atkname}](~repeating_attack_attack_crit)}} {{r1=[[" + r1 + "cs>@{atkcritrange}" + hbonus + "]]}} " + r2 + "cs>@{atkcritrange}" + hbonus + "]]}} {{range=@{atkrange}}} {{desc=@{atk_desc}}} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globalattack=@{global_attack_mod}}} {{duration=@{duration}}} {{castdc=@{castdc}}} @{charname_output}";
					} else if (v["repeating_attack_" + attackid + "_dmgflag"] && v["repeating_attack_" + attackid + "_dmgflag"] != 0) {
						pickbase = "dmg";
						rollbase = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + dmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + dmg2type + "}} {{desc=@{atk_desc}}} @{hldmg} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globaldamage=" + globaldamage + "}} {{globaldamagetype=@{global_damage_mod_type}}} {{duration=@{duration}}} @{charname_output}"
					} else {
						pickbase = "empty";
						rollbase = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} {{desc=@{atk_desc}}} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{duration=@{duration}}} @{charname_output}"
					}
					update["repeating_attack_" + attackid + "_rollbase_dmg"] = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + dmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + dmg2type + "}} {{desc=@{atk_desc}}} @{hldmg} {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globaldamage=" + globaldamage + "}} {{globaldamagetype=@{global_damage_mod_type}}} @{charname_output}";
					update["repeating_attack_" + attackid + "_rollbase_crit"] = "@{wtype}&{template:dmg} {{crit=1}} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + dmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + dmg2type + "}} {{crit1=[[" + crit1 + "]]}} {{crit2=[[" + crit2 + "]]}} {{desc=@{atk_desc}}} @{hldmg} " + hldmgcrit + " {{spelllevel=@{spelllevel}}} {{innate=@{spell_innate}}} {{globaldamage=" + globaldamage + "}} {{globaldamagecrit=" + globaldamagecrit + "}} {{globaldamagetype=@{global_damage_mod_type}}} @{charname_output}"
					update["repeating_attack_" + attackid + "_atkbonus"] = bonus;
					update["repeating_attack_" + attackid + "_atkdmgtype"] = dmg + dmgspacer + dmg2 + dmgmag + " ";
					update["repeating_attack_" + attackid + "_rollbase"] = rollbase;
					if (v["repeating_attack_" + attackid + "_spellid"] && v["repeating_attack_" + attackid + "_spellid"] != "" && (!source || source && source != "spell") && v["repeating_attack_" + attackid + "_spellid"].length == 20) {
						var spellid = v["repeating_attack_" + attackid + "_spellid"];
						var lvl = v["repeating_attack_" + attackid + "_spelllevel"];
						callbacks.push(function() {
							update_spell_from_attack(lvl, spellid, attackid);
						});
					}
					if (v["repeating_attack_" + attackid + "_itemid"] && v["repeating_attack_" + attackid + "_itemid"] != "" && (!source || source && source != "item")) {
						var itemid = v["repeating_attack_" + attackid + "_itemid"];
						callbacks.push(function() {
							update_item_from_attack(itemid, attackid);
						});
					}
					setAttrs(update, {
						silent: true
					}, function() {
						callbacks.forEach(function(callback) {
							callback();
						})
					});
				});
			});
		};

		var remove_attack = function(attackid) {
			removeRepeatingRow("repeating_attack_" + attackid);
		};

		var remove_resource = function(id) {
			var update = {};
			getAttrs([id + "_itemid"], function(v) {
				var itemid = v[id + "_itemid"];
				if (itemid) {
					update["repeating_inventory_" + itemid + "_useasresource"] = 0;
					update["repeating_inventory_" + itemid + "_itemresourceid"] = "";
				};
				if (id == "other_resource") {
					update["other_resource"] = "";
					update["other_resource_name"] = "";
					update["other_resource_itemid"] = "";
					setAttrs(update, {
						silent: true
					});
				} else {
					var baseid = id.replace("repeating_resource_", "").substring(0, 20);
					var resource_names = ["repeating_resource_" + baseid + "_resource_left_name", "repeating_resource_" + baseid + "_resource_right_name"];
					getAttrs(resource_names, function(v) {
						if ((id.indexOf("left") > -1 && !v["repeating_resource_" + baseid + "_resource_right_name"]) || (id.indexOf("right") > -1 && !v["repeating_resource_" + baseid + "_resource_left_name"])) {
							removeRepeatingRow("repeating_resource_" + baseid);
						} else {
							update["repeating_resource_" + id.replace("repeating_resource_", "")] = "";
							update["repeating_resource_" + id.replace("repeating_resource_", "") + "_name"] = "";
						};
						setAttrs(update, {
							silent: true
						});
					});

				};
			});
		};

		var update_initiative = function() {
			var attrs_to_get = ["dexterity", "dexterity_mod", "init_tiebreaker"];
			getAttrs(attrs_to_get, function(v) {
				var update = {};
				var final_init = parseInt(v["dexterity_mod"], 10);
				if (v["init_tiebreaker"] && v["init_tiebreaker"] != 0) {
					final_init = final_init + parseFloat((parseInt(v["dexterity"], 10) / 100).toFixed(2));
				}
				update["initiative_bonus"] = final_init;
				setAttrs(update, {
					silent: true
				});
			});
		};

		on("change:xp", function(eventinfo) {
			getAttrs(["lifetime_xp", "base_level"], function(v) {
				const minLevel = 0;
				const maxLevel = 10;
				const maxTotalXp = 450;
				let xp = parseInt(eventinfo.newValue, 10) || 0;
				let update = {};
				if (xp < 0) { xp = 0; update["xp"] = xp; }
				if (xp > maxTotalXp) { xp = maxTotalXp; update["xp"] = xp; }
				let level = Math.max(0, parseInt(v.base_level, 10) || minLevel);
				let lifetimeXp = xp + getTotalXpForLevel(level);
				let ascended = level > minLevel && level < maxLevel && xp >= level * 10;
				console.log("current xp is now: " + xp + "; lifetime XP is now: " + lifetimeXp + "; ascended: " + ascended);
				update["lifetime_xp"] = lifetimeXp;
				update["levelup"] = ascended ? 1 : 0; // set level up readiness indicator
				setAttrs(update, {
					silent: true
				});
			});
		});

		var getTotalXpForLevel = function(level)
		{
			// base cases
			if (level <= 1) return 0;
			// limit = level 10 (for now ? not counting 3rd party stuff)
			if (level > 10) return getTotalXpForLevel(10);
			// recurse
			return getTotalXpForLevel(level - 1) + (level - 1) * 10;
		}

		var set_level = function(level, oldLevel) {
			getAttrs(["xp", "lifetime_xp"], function(v) {
				console.log("level changed (" + oldLevel + "=>" + level + ") reset xp and adjust xp for next level");
				var update = {};
				const minLevel = 0;
				const maxLevel = 10;
				const maxLifetimeXp = 450;
				if (level < minLevel) { level = minLevel; update["base_level"] = level; };
				if (level > maxLevel) { level = maxLevel; update["base_level"] = level; };

				// SD uses next level xp equals cur level * 10
				let lastLevelXp = level > minLevel + 1 ? (level - 1) * 10 : 0;
				let nextLevelXp = level < maxLevel ? level * 10 : 0;
				let xp = Math.max(0, parseInt(v.xp, 10) || 0);
				let lifetimeXp = (v.lifetime_xp && v.lifetime_xp > 0) ? parseInt(v.lifetime_xp, 10) : 0;
				if (lifetimeXp > maxLifetimeXp) { lifetimeXp = maxLifetimeXp; update["lifetime_xp"] = lifetimeXp; };
				if (level < oldLevel) { 
					// level down: fix xp to avoid losing total xp (people make mistakes)
					xp = lifetimeXp - getTotalXpForLevel(level);
				}
				else if (level > 1) {
					if (level >= maxLevel) console.log ("Maximum level achieved!");
					if (xp >= lastLevelXp) {
						// normal level up based on XP (assume player didn"t cheat; track total xp in case of mistakes)
						// reset XP to 0 and carry over remainder if exceeded required amount
						xp = level < maxLevel && xp >= lastLevelXp ? xp - (oldLevel * 10) : 0;
					}
					else {
						// skip: level up without required xp (milestone leveling or starting a high level PC?)
						// increase lifetime_xp to match, and set current to 0
						lifetimeXp = getTotalXpForLevel(level);
						update["lifetime_xp"] = lifetimeXp;
						xp = 0;
					}
				}

				update["levelup"] = xp >= nextLevelXp ? 1 : 0; // set level up readiness indicator
				update["xp"] = xp;
				update["xp_nextlevel"] = nextLevelXp;
				setAttrs(update, {
					silent: true
				});
			});
		};

		var update_npc_action = function(update_id, legendary) {
			if (update_id.substring(0, 1) === "-" && update_id.length === 20) {
				do_update_npc_action([update_id], legendary);
			} else if (update_id === "all") {
				var legendary_array = [];
				var actions_array = [];
				getSectionIDs("repeating_npcaction-l", function(idarray) {
					legendary_array = idarray;
					if (legendary_array.length > 0) {
						do_update_npc_action(legendary_array, true);
					}
					getSectionIDs("repeating_npcaction", function(idarray) {
						actions_array = idarray.filter(function(i) {
							return legendary_array.indexOf(i) < 0;
						});
						if (actions_array.length > 0) {
							do_update_npc_action(actions_array, false);
						};
					});
				});
			};
		};

		var do_update_npc_action = function(action_array, legendary) {
			var repvar = legendary ? "repeating_npcaction-l_" : "repeating_npcaction_";
			var action_attribs = [];
			_.each(action_array, function(actionid) {
				action_attribs.push(repvar + actionid + "_attack_flag");
				action_attribs.push(repvar + actionid + "_attack_type");
				action_attribs.push(repvar + actionid + "_attack_range");
				action_attribs.push(repvar + actionid + "_attack_target");
				action_attribs.push(repvar + actionid + "_attack_tohit");
				action_attribs.push(repvar + actionid + "_attack_damage");
				action_attribs.push(repvar + actionid + "_attack_damagetype");
				action_attribs.push(repvar + actionid + "_attack_damage2");
				action_attribs.push(repvar + actionid + "_attack_damagetype2");
			});

			getAttrs(action_attribs, function(v) {
				_.each(action_array, function(actionid) {
					console.log("UPDATING NPC ACTION: " + actionid);
					var callbacks = [];
					var update = {};
					var onhit = "";
					var damage_flag = "";
					var range = "";
					var attack_flag = v[repvar + actionid + "_attack_flag"] && v[repvar + actionid + "_attack_flag"] != "0" ? "{{attack=1}}" : "";
					var tohit = v[repvar + actionid + "_attack_tohit"] && isNaN(parseInt(v[repvar + actionid + "_attack_tohit"], 10)) === false ? parseInt(v[repvar + actionid + "_attack_tohit"], 10) : 0;
					if (v[repvar + actionid + "_attack_type"] && v[repvar + actionid + "_attack_range"]) {
						if (v[repvar + actionid + "_attack_type"] === "Melee") {
							var rangetype = "Reach";
						} else {
							var rangetype = "Range";
						};
						range = ", " + rangetype + " " + v[repvar + actionid + "_attack_range"];
					}
					var target = v[repvar + actionid + "_attack_target"] && v[repvar + actionid + "_attack_target"] != "" ? ", " + v[repvar + actionid + "_attack_target"] : ""
					var attack_tohitrange = "+" + tohit + range + target;
					var dmg1 = v[repvar + actionid + "_attack_damage"] && v[repvar + actionid + "_attack_damage"] != "" ? v[repvar + actionid + "_attack_damage"] : "";
					var dmg1type = v[repvar + actionid + "_attack_damagetype"] && v[repvar + actionid + "_attack_damagetype"] != "" ? " " + v[repvar + actionid + "_attack_damagetype"] : "";
					var dmg2 = v[repvar + actionid + "_attack_damage2"] && v[repvar + actionid + "_attack_damage2"] != "" ? v[repvar + actionid + "_attack_damage2"] : "";
					var dmg2type = v[repvar + actionid + "_attack_damagetype2"] && v[repvar + actionid + "_attack_damagetype2"] != "" ? " " + v[repvar + actionid + "_attack_damagetype2"] : "";
					var dmgspacer = dmg1 != "" && dmg2 != "" ? " plus " : "";

					var parsed_dmg1 = parse_roll_string(dmg1);
					var parsed_dmg2 = parse_roll_string(dmg2);

					if (dmg1 != "") {
						onhit = onhit + parsed_dmg1.avg + " (" + dmg1 + ")" + dmg1type + " damage";
					};
					dmgspacer = dmg1 != "" && dmg2 != "" ? " plus " : "";
					onhit = onhit + dmgspacer;
					if (dmg2 != "") {
						onhit = onhit + parsed_dmg2.avg + " (" + dmg2 + ")" + dmg2type + " damage";
					};
					if (dmg1 != "" || dmg2 != "") {
						damage_flag = damage_flag + "{{damage=1}} "
					};
					if (dmg1 != "") {
						damage_flag = damage_flag + "{{dmg1flag=1}} "
					};
					if (dmg2 != "") {
						damage_flag = damage_flag + "{{dmg2flag=1}} "
					};

					var crit1 = "";
					if (parsed_dmg1.rolls.length > 0) {
						parsed_dmg1.rolls.forEach(function(value) {
							crit1 += parsed_dmg1.array[value] + "+";
						});
						crit1 = crit1.substring(0, crit1.length - 1);
					}

					var crit2 = "";
					if (parsed_dmg2.rolls.length > 0) {
						parsed_dmg2.rolls.forEach(function(value) {
							crit2 += parsed_dmg2.array[value] + "+";
						});
						crit2 = crit2.substring(0, crit2.length - 1);
					}

					var rollbase = "";
					if (v[repvar + actionid + "_attack_flag"] && v[repvar + actionid + "_attack_flag"] != "0") {
						if (legendary) {
							rollbase = "@{wtype}&{template:npcatk} " + attack_flag + " @{damage_flag} @{npc_name_flag} {{rname=[@{name}](~repeating_npcaction-l_npc_dmg)}} {{rnamec=[@{name}](~repeating_npcaction-l_npc_crit)}} {{type=[Attack](~repeating_npcaction-l_npc_dmg)}} {{typec=[Attack](~repeating_npcaction-l_npc_crit)}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} {{description=@{show_desc}}} @{charname_output}"
						} else {
							rollbase = "@{wtype}&{template:npcatk} " + attack_flag + " @{damage_flag} @{npc_name_flag} {{rname=[@{name}](~repeating_npcaction_npc_dmg)}} {{rnamec=[@{name}](~repeating_npcaction_npc_crit)}} {{type=[Attack](~repeating_npcaction_npc_dmg)}} {{typec=[Attack](~repeating_npcaction_npc_crit)}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} {{description=@{show_desc}}} @{charname_output}";
						}
					} else if (dmg1 || dmg2) {
						rollbase = "@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} @{charname_output}"
					} else {
						rollbase = "@{wtype}&{template:npcaction} @{npc_name_flag} {{rname=@{name}}} {{description=@{show_desc}}} @{charname_output}"
					}

					update[repvar + actionid + "_attack_tohitrange"] = attack_tohitrange;
					update[repvar + actionid + "_attack_onhit"] = onhit;
					update[repvar + actionid + "_damage_flag"] = damage_flag;
					update[repvar + actionid + "_attack_crit"] = crit1;
					update[repvar + actionid + "_attack_crit2"] = crit2;
					update[repvar + actionid + "_rollbase"] = rollbase;
					setAttrs(update, {
						silent: true
					});
				});
			});
		};

		var parse_roll_string = function(rollstring) {
			var out = {
				array: [],
				avg: 0,
				rolls: []
			};

			if (!rollstring || rollstring === "") {
				return out;
			}

			var rs_regex_initial = /(\-?\d+(?:d\d+)?)/ig;
			var rs_regex_repeating = /([\+\-])(\-?\d+(?:d\d+)?)/ig;
			var rs_nospace = rollstring.replace(/\s/g, "");
			var rs_initial = rs_regex_initial.exec(rs_nospace);

			if (rs_initial) {
				out.array.push(rs_initial[1]);
				rs_regex_repeating.lastIndex = rs_regex_initial.lastIndex;
				var rs_repeating;
				while (rs_repeating = rs_regex_repeating.exec(rs_nospace)) {
					out.array.push(rs_repeating[1], rs_repeating[2]);
				}
			}

			var add = true;
			var dice_regex = /(\d+)d(\d+)/i;
			var dice;

			out.array.forEach(function(value, index, array) {
				if (value === "+") {
					add = true;
				} else if (value === "-") {
					add = false;
				} else if (dice = dice_regex.exec(value)) {
					// this value is a die roll
					var dice_avg = Math.floor(+dice[1] * (+dice[2] / 2 + 0.5));
					out.avg += add ? dice_avg : -dice_avg;
					out.rolls.push(index);
				} else {
					// this value is a number
					out.avg += add ? +value : - +value;
				}
			})

			return out;
		};

		let toInt = function(value) {
			return (value && !isNaN(value)) ? parseInt(value) : 0;
		};

		let clamp = function(value, min, max) {
			return Math.min(Math.max(value, min), max);
		};

		let isDefined = function(value) {
			return value !== null && typeof(value) !== "undefined";
		};
	</script>
</div>
